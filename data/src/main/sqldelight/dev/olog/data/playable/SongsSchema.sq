-- non blacklisted songs, use for derivate queries like folders, albums, etc
CREATE VIEW songs_view AS
SELECT indexed_playables.*
FROM indexed_playables
    LEFT JOIN blacklist ON indexed_playables.directory = blacklist.directory --remove blacklisted
WHERE blacklist.directory IS NULL --false alarm, can be null with the join
    AND is_podcast = 0;


-- sorted songs_view
CREATE VIEW sorted_songs_view AS
SELECT songs_view.*
FROM songs_view
    LEFT JOIN sort ON TRUE -- join with sort to observe table, keep on TRUE so WHERE clause is working
WHERE sort.table_name = 'songs'
ORDER BY
-- author, then title
CASE WHEN sort.column_name = 'author' AND author = '<unknown>' THEN -1 END, -- when unknown move last TODO test performance
CASE WHEN sort.column_name = 'author' AND sort.direction = 'asc' THEN lower(author) END COLLATE LOCALIZED ASC,
CASE WHEN sort.column_name = 'author' AND sort.direction = 'desc' THEN lower(author) END COLLATE LOCALIZED DESC,
-- collection, then title
CASE WHEN sort.column_name = 'collection' AND collection = '<unknown>' THEN -1 END, -- when unknown move last TODO test performance
CASE WHEN sort.column_name = 'collection' AND sort.direction = 'asc' THEN lower(collection) END COLLATE LOCALIZED ASC,
CASE WHEN sort.column_name = 'collection' AND sort.direction = 'desc' THEN lower(collection) END COLLATE LOCALIZED DESC,
-- duration, then title
CASE WHEN sort.column_name = 'duration' AND sort.direction = 'asc' THEN duration END ASC,
CASE WHEN sort.column_name = 'duration' AND sort.direction = 'desc' THEN duration END DESC,
-- recently added, then title
CASE WHEN sort.column_name = 'date_added' AND sort.direction = 'asc' THEN date_added END DESC,
CASE WHEN sort.column_name = 'date_added' AND sort.direction = 'desc' THEN date_added END ASC,

-- default, and second sort
-- also, CASE WHEN sort.column_name = 'title' AND sort.direction = 'asc'
CASE WHEN sort.direction = 'asc' THEN lower(title) END COLLATE LOCALIZED ASC,
CASE WHEN sort.direction = 'desc' THEN lower(title) END COLLATE LOCALIZED DESC;